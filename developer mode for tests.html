<!--
  This is a simple web page designed to run locally in your browser.  It provides a basic
  user interface for connecting to a Bambu Lab A1 3D printer on your local network.  The
  page allows you to enter the IP address or hostname of the printer (or Bambu Local
  Server) and perform simple API calls such as retrieving the printer status or pausing
  and resuming a print.  In its current form the page uses the Fetch API to send
  requests; these routes (e.g. `/api/printer/status`) are placeholders and must be
  adjusted to match the actual endpoints exposed by your printer or local server.
-->
<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Połączenie z drukarką Bambu A1 (Local)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background-color: #1c1c1e; /* dark background */
        color: #e0e0e0; /* light text */
      }
      h1, h2 {
        margin-bottom: 1rem;
        color: #ffffff;
      }
      label {
        display: block;
        margin-top: 1rem;
        font-weight: bold;
      }
      input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        margin-top: 0.5rem;
        background-color: #2c2c2e;
        color: #e0e0e0;
        border: 1px solid #555;
        border-radius: 4px;
      }
      button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        background-color: #007acc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background-color: #555;
      }
      .status {
        margin-top: 1rem;
        padding: 0.5rem;
        background-color: #2a2a2e;
        border-left: 4px solid #007acc;
        color: #e0e0e0;
      }
      .error {
        background-color: #4d2b2b;
        border-left: 4px solid #d93025;
      }
      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal {
        background-color: #2c2c2e;
        color: #e0e0e0;
        padding: 1.5rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .modal h2 {
        margin-top: 0;
        color: #ffffff;
      }
      .modal button {
        background-color: #444;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>Połączenie z drukarką Bambu A1</h1>
    <p>Wprowadź adres IP lub nazwę hosta swojego serwera lokalnego lub drukarki, a następnie użyj przycisków, aby pobrać status wydruku lub wstrzymać/wznowić drukowanie. Wymagany jest włączony <strong>Developer Mode</strong> lub zainstalowany <em>Bambu Local Server</em> z odpowiednim API.</p>

    <!-- Button to open developer mode instructions -->
    <button id="devModeGuideBtn">Instrukcja: Włączanie trybu deweloperskiego</button>
    <label for="printerAddress">Adres IP / host:</label>
    <input type="text" id="printerAddress" placeholder="np. 192.168.1.123:7070" />
    <div>
      <button id="statusButton">Pobierz status</button>
      <button id="pauseButton">Pauza</button>
      <button id="resumeButton">Wznów</button>
    </div>
    <div id="response" class="status" hidden></div>

    <!-- Modal for developer mode instructions -->
    <div id="devModalOverlay" class="modal-overlay">
      <div class="modal">
        <h2>Jak włączyć Developer Mode na Bambu&nbsp;A1</h2>
        <ol>
          <li>Na ekranie drukarki wejdź w menu <strong>Ustawienia</strong>.</li>
          <li>Wybierz opcję <strong>LAN Only Mode</strong> i aktywuj tryb tylko‑LAN【344832273849837†L180-L193】.</li>
          <li>Następnie w tym samym menu znajdź pozycję <strong>Developer Mode</strong> i włącz ją【344832273849837†L194-L206】.</li>
          <li>Przeczytaj wyświetloną informację o ryzyku, zaznacz pole potwierdzające i kliknij <em>Enable</em>【344832273849837†L196-L206】.</li>
          <li>Po aktywacji przycisk powinien świecić się na zielono – to oznacza, że tryb jest włączony【344832273849837†L204-L206】.</li>
        </ol>
        <p>W trybie deweloperskim drukarka działa wyłącznie w sieci lokalnej i nie łączy się z chmurą Bambu. Aby przywrócić połączenie z chmurą, wyłącz Developer Mode w ustawieniach drukarki.</p>
        <button id="closeDevModal">Zamknij</button>
      </div>
    </div>

    <h2 style="margin-top:2rem;">Podgląd z kamery</h2>
    <p>Podłączony w drukarce moduł kamery umożliwia podgląd wydruku. W trybie deweloperskim/lokalnym serwerze Bambu dostępne są zazwyczaj niskoczęstotliwościowe zrzuty (snapshots). Poniższy przycisk wysyła żądanie po aktualny obraz. Ścieżka do obrazu (`/api/printer/snapshot`) jest przykładowa i powinna zostać dostosowana do faktycznego endpointu.</p>
    <button id="cameraButton">Odśwież podgląd</button>
    <div>
      <img id="cameraFeed" alt="Podgląd kamery" style="display:none; margin-top:1rem; max-width:100%; border:1px solid #ccc;" />
    </div>
    <script>
      /**
       * Helper function to perform a fetch request against the printer/local server API.
       * It displays the result or error message in the response container.
       */
      async function callApi(path) {
        const address = document.getElementById('printerAddress').value.trim();
        const responseEl = document.getElementById('response');
        if (!address) {
          responseEl.textContent = 'Proszę podać adres drukarki lub serwera.';
          responseEl.classList.add('error');
          responseEl.hidden = false;
          return;
        }
        const url = `http://${address}${path}`;
        try {
          responseEl.hidden = false;
          responseEl.textContent = 'Ładowanie…';
          responseEl.classList.remove('error');
          const res = await fetch(url);
          if (!res.ok) {
            throw new Error(`Kod błędu ${res.status}`);
          }
          const data = await res.json();
          responseEl.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          responseEl.textContent = `Błąd: ${err.message}`;
          responseEl.classList.add('error');
        }
      }
      document.getElementById('statusButton').addEventListener('click', () => {
        // Endpoint to get printer status; adjust according to actual API definition
        callApi('/api/printer/status');
      });
      document.getElementById('pauseButton').addEventListener('click', () => {
        // Endpoint to pause the current print job; adjust according to actual API definition
        callApi('/api/printer/pause');
      });
      document.getElementById('resumeButton').addEventListener('click', () => {
        // Endpoint to resume a paused print job; adjust according to actual API definition
        callApi('/api/printer/resume');
      });

      // Function to refresh the camera snapshot. Adjust the path according to your API.
      function refreshCamera() {
        const address = document.getElementById('printerAddress').value.trim();
        const imgEl = document.getElementById('cameraFeed');
        if (!address) {
          alert('Proszę podać adres drukarki lub serwera, aby wyświetlić podgląd kamery.');
          return;
        }
        // Append a timestamp to avoid caching the same image
        const snapshotPath = '/api/printer/snapshot';
        imgEl.src = `http://${address}${snapshotPath}?t=${Date.now()}`;
        imgEl.style.display = 'block';
      }
      document.getElementById('cameraButton').addEventListener('click', refreshCamera);

      // Developer mode instructions modal handling
      const devBtn = document.getElementById('devModeGuideBtn');
      const devModalOverlay = document.getElementById('devModalOverlay');
      const closeDevModal = document.getElementById('closeDevModal');
      devBtn.addEventListener('click', () => {
        devModalOverlay.style.display = 'flex';
      });
      closeDevModal.addEventListener('click', () => {
        devModalOverlay.style.display = 'none';
      });
      // Close modal when clicking outside the dialog box
      devModalOverlay.addEventListener('click', (e) => {
        if (e.target === devModalOverlay) {
          devModalOverlay.style.display = 'none';
        }
      });
    </script>
  </body>
</html>